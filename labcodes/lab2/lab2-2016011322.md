## Lab 2 实验报告

### 计64 陶东来 2016011322

### 练习1

- `default_init`，无需修改。
- `default_init_memmap`，作用是将起始地址为`base`的连续n个页加入链表结构中。过程中需要对页的状态进行初始化，设置flags中property位。
- `default_alloc_pages`，作用是从空闲链表中申请连续n个空闲页。做法是O(n)扫描链表，找到第一个大于等于n的连续空闲页块，将前n块取出，剩余的部分截断放回列表中。对于取出的那些页，需要使用`SetPageReserved`和`ClearPageProperty`来标记其为使用状态。
- `default_free_pages`，作用是将`base`开始的连续n个页释放，重现加入链表中。做法是扫描链表，找出这n个页应该插入的位置。同时还需要检查和前后节点是否连续，如果连续应该合并节点。


#### 可以优化的地方

在`default_alloc_pages`中，可以应用next-fit技术。具体来说，每次遍历并不是从头开始，而是从上一回分配的位置开始向后循环搜索。这样的做法是有道理的，在每次需要分配的页量相近的情况下，在上次分配之前的位置*几乎*不可能适合这一次分配。这样做的一个显而易见的问题是内存的碎片化会比first-fit更为严重，需要其他的技术来辅助解决这样的问题。


### 练习 2

在`get_pte`中，我们需要先检查二级页表项是否存在。若不存在，我们则需要为其分配一个二级页表。页目录项由`pgdir[PDX(la)]`给出。通过检查`PTE_P`的对应标志位，我们可以知道该二级页表是否存在。若发现不存在，如果要求了`create`，就会调用`alloc_page`，分配一个物理页用作该二级页表。这样，线性地址`la`对应的二级页表项就是该页中的`PTX(la)`。

#### PDE和PTE各部分含义和对ucore而言的潜在用处

各部分含义课件中有，不再赘述。PRW位直接用于维护页表，US可用于权限管理。PS位用于标记页大小，G位可以让TLB中被频繁使用的页不失效，提高效率。

#### 页访问异常中硬件的工作

CPU在当前内核栈保存当前被打断的程序现场，即依次压入当前被打断程序使用的EFLAGS，CS，EIP，errorCode；由于页访问异常的中断号是0xE，CPU把异常中断号0xE对应的中断服务例程的地址（vectors.S中的标号vector14处）加载到CS和EIP寄存器中，开始执行中断服务例程。接下来就会进入ucore的异常处理中断了。

### 练习 3

这里比较简单。将二级页表项取出，减1所在二级页表的引用计数，若引用计数减到0就将该二级页表也free。接着清空该二级页表项，刷新tlb内容即可。

#### pages全局变量

pages全局变量存储了探测到的所有free物理页的信息。 

#### 虚拟地址与物理地址相等

这需要从一开始就修改映射关系。
